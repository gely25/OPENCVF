<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Repaso Flashcards</title>
  <style>
    .card { 
      width:300px; height:200px; perspective:1000px; 
      margin: 20px auto; cursor:pointer; position: relative;
    }
    .card-inner { 
      position:relative; width:100%; height:100%;
      transition: transform 0.7s; transform-style: preserve-3d;
    }
    .card.flipped .card-inner { transform: rotateY(180deg); }
    .front, .back {
      position:absolute; width:100%; height:100%; backface-visibility:hidden;
      border-radius:10px; display:flex; align-items:center; justify-content:center;
      box-shadow: 0 8px 20px rgba(0,0,0,0.2); font-size:24px;
      padding:10px; text-align:center;
    }
    .front { background:#fff; }
    .back { background:#f0f0f0; transform:rotateY(180deg); flex-direction: column; }
    .back img { max-width:100%; max-height:100px; border-radius:5px; margin-top:10px; }
    .speak-btn {
      position: absolute;
      top: 10px; right: 10px;
      padding:5px 10px; font-size:16px;
      cursor: pointer;
    }
    .review-btn { 
      margin:10px; padding:10px 20px; font-size:16px; cursor:pointer;
    }
  </style>
</head>
<body>
  <h1>Repaso Flashcards</h1>

  <p style="text-align:center;" id="counter">0/0</p>

  <div class="card" id="flashcard">
    <div class="card-inner">
      <div class="front">
        <span id="frontText"></span>
        <button class="speak-btn" id="speakBtn">üîä</button>
      </div>
      <div class="back">
        <span id="backText"></span>
        <img id="backImg" src="" alt="" style="display:none;">
      </div>
    </div>
  </div>

  <div style="text-align:center;">
    <button class="review-btn" id="rememberBtn">‚úÖ Record√©</button>
    <button class="review-btn" id="forgetBtn">‚ùå No record√©</button>
  </div>

  <script>
    let flashcards = {{ flashcards|safe }};
    const frontText = document.getElementById("frontText");
    const backText = document.getElementById("backText");
    const backImg = document.getElementById("backImg");
    const counter = document.getElementById("counter");
    const card = document.getElementById("flashcard");
    const speakBtn = document.getElementById("speakBtn");
    const rememberBtn = document.getElementById("rememberBtn");
    const forgetBtn = document.getElementById("forgetBtn");

    let currentIndex = 0;

    function showCard(index) {
      if(flashcards.length === 0){
        frontText.textContent = "¬°Repaso completado!";
        backText.textContent = "";
        backImg.style.display = "none";
        counter.textContent = "0/0";
        return;
      }

      const c = flashcards[index];
      frontText.textContent = c.palabra;
      backText.textContent = c.traduccion;
      if(c.imagen){
        backImg.src = c.imagen;
        backImg.style.display = "block";
      } else {
        backImg.style.display = "none";
      }
      counter.textContent = `${index+1}/${flashcards.length}`;
      card.classList.remove("flipped");
    }

    function markAsReviewed(success=true){
      const id = flashcards[currentIndex].id;
      fetch(`/flashcards/${id}/reviewed/`, {
          method: "POST",
          headers: {'X-CSRFToken': '{{ csrf_token }}'},
          body: JSON.stringify({success: success})
      });
    }

    // Bot√≥n "Record√©" ‚Üí eliminar de la lista
    rememberBtn.addEventListener("click", () => {
      markAsReviewed(true);
      flashcards.splice(currentIndex, 1);
      if(currentIndex >= flashcards.length) currentIndex = 0;
      showCard(currentIndex);
    });

    // Bot√≥n "No record√©" ‚Üí pasar a la siguiente tarjeta, no eliminar
    forgetBtn.addEventListener("click", () => {
      markAsReviewed(false);
      currentIndex = (currentIndex + 1) % flashcards.length;
      showCard(currentIndex);
    });

    // Voltear tarjeta
    card.addEventListener("click", (e) => {
      if(e.target === speakBtn) return;
      card.classList.toggle("flipped");
    });

    // Audio
    speakBtn.addEventListener("click", (e) => {
      e.stopPropagation();
      const utterance = new SpeechSynthesisUtterance(flashcards[currentIndex].palabra);
      utterance.lang = "en-US";
      speechSynthesis.speak(utterance);
    });

    // Mostrar primera tarjeta
    showCard(currentIndex);
  </script>
</body>
</html>
